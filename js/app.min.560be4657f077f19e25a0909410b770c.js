function modUrl(a,b){return a=a.replace("/^https?:/",""),a=-1!=a.search(/\/(s|p)\d{3}x\d{3}\//)?a.replace(/\/(s|p)\d{3}x\d{3}\//,"/"+b+"/"):a.replace(/\/(?!.*\/)/,"/"+b+"/")}function transition(a,b,c){Dimg.style.left=a+"px",Dimg.style.top=b+"px",Dimg.style.transform="rotate("+c+"deg)",Dimg.style.webkitTransform="rotate("+c+"deg)"}function play(){Dimg.addEventListener("transitionend",newPic,!1),transition(Xfin,Yfin,Rotfin)}function pause(){if(Dimg.removeEventListener("transitionend",newPic,!1),Dimg.style.left=window.getComputedStyle(Dimg).getPropertyValue("left"),Dimg.style.top=window.getComputedStyle(Dimg).getPropertyValue("top"),window.getComputedStyle(Dimg).getPropertyValue("transform"))var a=window.getComputedStyle(Dimg).getPropertyValue("transform").match(/\(([^,]+), ?([^,]+),/);else var a=window.getComputedStyle(Dimg).getPropertyValue("-webkit-transform").match(/\(([^,]+), ?([^,]+),/);var b=Math.round(Math.atan2(a[2],a[1])*(180/Math.PI));Dimg.style.transform="rotate("+b+"deg)",Dimg.style.webkitTransform="rotate("+b+"deg)";var c=(3*(Yfin-parseFloat(Dimg.style.top))/(Yfin-Yini)).toFixed(2);Dimg.style.transition="transform "+c+"s, left "+c+"s, top "+c+"s",Dimg.style.webkitTransition="-webkit-transform "+c+"s, left "+c+"s, top "+c+"s"}function restart(){$container.empty(),n=0,list.shuffle(),extendList()}function fullScreen(){document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}function normalScreen(){document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()}function polaroid(){document.body.classList.add("showPolaroid")}function noPolaroid(){document.body.classList.remove("showPolaroid")}function albumSelected(a){var b=a.currentTarget;0==listAlchecked[b.id.slice(1)]?(b.children[1].setAttribute("class","albumSelected"),listAlchecked[b.id.slice(1)]=1):(b.children[1].setAttribute("class","albumNotSelected"),listAlchecked[b.id.slice(1)]=0)}function FchooseAccept(){listTmp=new Array;for(var a=0;a<listAlchecked.length;a++)if(1==listAlchecked[a])for(var b=0;b<fbList[a][3].length;b++)listTmp.push(fbList[a][3][b]);0==listTmp.length?alert("Debes seleccionar al menos un album"):($container.empty(),n=0,list=listTmp,list.shuffle(),extendList(),$blackout.hide(),$albumChoose.hide())}function FchooseCancel(){$blackout.hide(),$albumChoose.hide(),play()}function loadAlbumChoose(){if(nAlPic>0&&nAlPic<=fbList.length&&(dimgAl.style.backgroundImage='url("'+fbList[nAlPic-1][2]+'")'),nAlPic<fbList.length){var a=document.createElement("div");a.setAttribute("id","a"+nAlPic),a.setAttribute("class","divPhoto"),a.addEventListener("click",albumSelected,!1),dimgAl=document.createElement("div"),a.appendChild(dimgAl),TimgAl=document.createElement("div"),nAlPic<fbList.length-2?(TimgAl.setAttribute("class","albumSelected"),listAlchecked[nAlPic]=1):(TimgAl.setAttribute("class","albumNotSelected"),listAlchecked[nAlPic]=0),a.appendChild(TimgAl);var b=document.createElement("img");b.addEventListener("load",loadAlbumChoose,!1),b.addEventListener("error",loadAlbumChoose,!1),b.src=fbList[nAlPic][2];var c=document.createElement("span");c.innerHTML=fbList[nAlPic][1],a.appendChild(c),$albumChoose.append(a)}else{var d=document.createElement("div"),e=document.createElement("div");e.setAttribute("class","BtnChoose"),e.innerHTML="Aceptar",e.addEventListener("click",FchooseAccept,!1);var f=document.createElement("div");f.setAttribute("class","BtnChoose"),f.innerHTML="Cancelar",f.addEventListener("click",FchooseCancel,!1),d.appendChild(e),d.appendChild(f),$albumChoose.append(d),onInit&&(onInit=!1,getFriendList())}nAlPic++}function filterAlbum(){$albumChoose.is(":hidden")?($friendsChoose.is(":visible")&&$friendsChoose.hide(),pause(),$blackout.show(),$albumChoose.show()):($blackout.hide(),$albumChoose.hide(),play())}function friendSelected(a){var b=a.currentTarget;b.id.slice(1)!=nFrSelected&&(b.children[1].setAttribute("class","albumSelected"),document.getElementById("f"+nFrSelected).children[1].setAttribute("class","albumNotSelected"),nFrSelected=parseInt(b.id.slice(1)))}function FfriendsAccept(){$blackout.hide(),$friendsChoose.hide(),$container.empty(),n=0,nAl=0,list=new Array,$albumChoose.empty(),nAlPic=0,listAlchecked=new Array,newFriend=1,fbListSaved=!1;for(var a=0;a<allFbList.length;a++)if(allFbList[a].id==friendList[nFrSelected][0]){fbList=allFbList[a].fbList,fbListSaved=!0;break}fbListSaved?makePhotoList():($loader.show(),$loadingAlbums.hide(),fbList=new Array,appInit())}function FfriendsCancel(){$blackout.hide(),$friendsChoose.hide(),play()}function getFriendList(){FB.api("me/friends?fields=name,id&limit=5000",function(a){for(var b=0;b<a.data.length;b++)friendList[b+1]=new Array,friendList[b+1][0]=a.data[b].id,friendList[b+1][1]=a.data[b].name;loadFriendsChoose()})}function loadFriendsChoose(){if(nFr>0&&nFr<=friendList.length&&(dimgFr.style.backgroundImage='url("https://graph.facebook.com/'+friendList[nFr-1][0]+'/picture?width=100&height=100")'),nFr<friendList.length){var a=document.createElement("div");a.setAttribute("id","f"+nFr),a.setAttribute("class","divPhoto"),a.addEventListener("click",friendSelected,!1),dimgFr=document.createElement("div"),a.appendChild(dimgFr),TimgAl=document.createElement("div"),0==nFr?TimgAl.setAttribute("class","albumSelected"):TimgAl.setAttribute("class","albumNotSelected"),a.appendChild(TimgAl);var b=document.createElement("img");b.addEventListener("load",loadFriendsChoose,!1),b.addEventListener("error",loadFriendsChoose,!1),b.src="https://graph.facebook.com/"+friendList[nFr][0]+"/picture?width=100&height=100";var c=document.createElement("span");c.innerHTML=friendList[nFr][1],a.appendChild(c),$friendsChoose.append(a)}else{var d=document.createElement("div"),e=document.createElement("div");e.setAttribute("class","BtnChoose"),e.innerHTML="Aceptar",e.addEventListener("click",FfriendsAccept,!1);var f=document.createElement("div");f.setAttribute("class","BtnChoose"),f.innerHTML="Cancelar",f.addEventListener("click",FfriendsCancel,!1),d.appendChild(e),d.appendChild(f),$friendsChoose.append(d)}nFr++}function friends(){$friendsChoose.is(":hidden")?($albumChoose.is(":visible")&&$albumChoose.hide(),pause(),$("#controls").css("background-color","rgba(0, 0, 0, 0.6)"),$blackout.show(),friendsChoose.show()):($("#controls").css("background-color",""),$blackout.hide(),friendsChoose.hide())}function login(){FB.getLoginStatus(function(a){"connected"===a.status?appInit(a):FB.login(function(a){a.authResponse&&appInit(a)},{scope:"user_photos, user_friends"})})}function appInit(a){$("#fbLoginBtn").hide(),$loader.show(),friendList[0][0]=a.authResponse.userID,accessToken=a.authResponse.accessToken,window.firstGetAlbum=!0,getAlbumsData(alParams)}function orderFbList(){var a,b,c,d=[];$.each(fbList,function(e,f){switch(f.type){case"profile":a=f;break;case"wall":b=f;break;case"cover":c=f;break;default:f.count&&d.push(f)}}),d.unshift(a),d.push(b,c),fbList=d}function getAlbumsData(a){FB.api("/"+friendList[nFrSelected][0],a,function(a){if(!a.albums)return void alert("connection error");if(a=a.albums,firstGetAlbum&&(firstGetAlbum=!1,$loader.hide(),$loadingAlbums.show()),$("#infoLoad2").text(Number($("#infoLoad2").text())+a.data.length),a.data&&a.data.length)if(fbList=fbList.concat(a.data),a.paging&&a.paging.next){var b=JSON.parse(JSON.stringify(alParams));b.after=a.paging.cursors.after,getAlbumsData(b)}else orderFbList(),getPhotosData(phParams)})}function proccessPhotoData(a){for(var b,c,d,e,f=0;f<photos.data.length;f++)b=a[f],fbList[nAl].cover_photo.id==b.id&&(fbList[nAl].cover_photo.src=modUrl(b.source,"p100x100")),c={},d=b.width,e=b.height,c.src=modUrl(b.source,"s320x320"),d>=e?(c.width=320,c.height=Math.floor(320/d*e)):(c.width=Math.floor(320/e*d),c.height=320),fbList[nAl].photos.push(c)}function getPhotosData(a){nAl<fbList.length&&FB.api("/"+fbList[nAl].id,a,function(a){})}function makePhotoList(){for(var a=0;a<fbList.length-2;a++)for(var b=0;b<fbList[a][3].length;b++)list.push(fbList[a][3][b]);list.shuffle(),extendList()}function extendList(){for(var a=-1,b=Math.floor(window.innerHeight/300),c=1,d=0,e=0,f=0,g=Math.floor(window.innerHeight%300/2),h=-d/2;e<list.length;){var i=(Math.floor(20*Math.random())+5)*a;list[e][3]=h,list[e][4]=g,list[e][5]=i,e++,h+=list[e-1][1]-d,a=-a,e<list.length-1?(h+list[e][1]-d>window.innerWidth&&(h=-d/2,g+=300-d/2,c++),c>b&&(c=1,g=Math.floor(window.innerHeight%300/2),list.shuffle(f,e-1),f=e)):list.shuffle(f,e-1)}$loader.hide(),$loadingAlbums.hide(),$("#play").each(function(){this.style.display="",this.classList.contains("flipped")||(this.dataset.title="Pause animation",this.classList.add("flipped"))}),$("#restart").show(),$("#friends").show(),newPic(),$("#filterAlbum").show()}function newPic(a){if(nPhoto<list.length){Rotfin=list[nPhoto][5];var b=Rotfin/Math.abs(Rotfin),c=Rotfin-20*b;Xfin=list[nPhoto][3],Xini=Xfin-300*b,Yfin=list[nPhoto][4],Yini=Yfin-window.innerHeight-50,Dimg=document.createElement("div"),Dimg.style.left=Xini+"px",Dimg.style.top=Yini+"px",Dimg.style.width=list[nPhoto][1]+"px",Dimg.style.height=list[nPhoto][2]+"px",Dimg.style.transform="rotate("+c+"deg)",Dimg.style.webkitTransform="rotate("+c+"deg)",Dimg.addEventListener("transitionend",newPic,!1);var d=document.createElement("canvas");d.width=300,d.height=360,context=d.getContext("2d"),context.fillStyle="#EEE",context.fillRect(0,0,300,360),img=new Image,img.addEventListener("load",onLoadImg,!1),img.addEventListener("error",newPic,!1),img.src=list[nPhoto][0],Dimg.appendChild(d),Dimg.appendChild(img),$container.append(Dimg),nPhoto++}}function onLoadImg(){var a=Math.min(img.width,img.height),b=Math.floor((img.width-a)/2),c=Math.floor((img.height-a)/4);context.drawImage(img,b,c,a,a,20,20,260,260),transition(Xfin,Yfin,Rotfin)}Array.prototype.swap=function(a,b){var c=this[a];this[a]=b,this[b]=c},Array.prototype.shuffle=function(a,b){"undefined"==typeof a&&(a=0),"undefined"==typeof b&&(b=this.length-1);for(var c,d,e=a;b>e;e++)c=Math.floor(Math.random()*(b-e))+e+1,d=this[e],this[e]=this[c],this[c]=d};var nAlPic=0,listAlchecked=new Array,dimgAl,newFriend=1,onInit=!0,nFr=0,nFrSelected=0,fbListSaved=!1,friendList=[[]];friendList[0][1]="Me";var dimgFr,$container=$("#container"),$albumChoose=$("#albumChoose"),$friendsChoose=$("#friendsChoose"),$blackout=$("#blackout"),$dots=$("#dots"),$loader=$("#loader"),$loadingAlbums=$("#loadingAlbums"),accessToken,allFbList=[],fbList=[],nAl=0,alParams={fields:"albums.limit(25){name,id,cover_photo,count,type,picture}"},phParams={fields:"photos.limit(25){id,images,width,height}"},list=[],context,Dimg,img,Xini,Xfin,Yini,Yfin,Rotfin,nPhoto=0;$("#toggleControls").click(function(){var a=document.body.classList;a.contains("showControls")?(this.dataset.title="Open controls",a.remove("showControls")):(this.dataset.title="Close controls",a.add("showControls"))}),$("#play").click(function(){this.style.pointerEvents="none",this.classList.contains("flipped")?(pause(),this.dataset.title="Play animation",this.classList.remove("flipped")):(play(),this.dataset.title="Pause animation",this.classList.add("flipped")),this.style.pointerEvents="auto"}),$("#restart").click(function(){this.style.pointerEvents="none",restart(),this.style.pointerEvents="auto"}),$("#fullScreen").click(function(){this.style.pointerEvents="none",this.classList.contains("flipped")?(normalScreen(),this.dataset.title="Go fullscreen",this.classList.remove("flipped")):(fullScreen(),this.dataset.title="Exit fullscreen",this.classList.add("flipped")),this.style.pointerEvents="auto"}),$("#polaroid").click(function(){this.style.pointerEvents="none",this.classList.contains("flipped")?(noPolaroid(),this.dataset.title="Polaroid frame",this.classList.remove("flipped")):(polaroid(),this.dataset.title="Normal frame",this.classList.add("flipped")),this.style.pointerEvents="auto"}),$("#filterAlbum").click(function(){this.style.pointerEvents="none",filterAlbum(),this.style.pointerEvents="auto"}),$("#friends").click(function(){this.style.pointerEvents="none",friends(),this.style.pointerEvents="auto"}),window.fbAsyncInit=function(){FB.init({appId:productionState?"640362006115757":"640370879448203",xfbml:!0,version:"v2.6"}),FB.getLoginStatus(function(a){"connected"===a.status?appInit(a):($loader.hide(),$("#fbLoginBtn").show())})},function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/en_US/sdk.js",e.parentNode.insertBefore(d,e))}(document,"script","facebook-jssdk");